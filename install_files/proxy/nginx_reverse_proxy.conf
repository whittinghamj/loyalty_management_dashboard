# IPTVShield.com v1

limit_req_zone $binary_remote_addr zone=subshieldLimit-high:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=subshieldLimit-medium:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=subshieldLimit-low:10m rate=30r/s;

log_format subshield "$msec,$remote_addr,$scheme://$host$request_uri,$request_time,$status";
log_format upstream_logging '[$time_local] $remote_addr - $remote_user - $server_name to: $upstream_addr: $request upstream_response_time $upstream_response_time msec $msec request_time $request_time Country: $geoip_country_code';

# GEO IP Filtering
map $geoip_country_code $proxy_traffic {
    default yes; # redirect traffic to main server by default

    # United Kingdom
    GB yes; # proxy traffic from this country
}


# uplink to main server
upstream main_server {
    ip_hash;
    server MAIN_SERVER_IP_ADDRESS:MAIN_SERVER_PORT;
}

# production hls-php proxy
server {
    server_name 127.0.0.1;
        
    listen 1372;

    index index.php index.html index.htm;
    root /var/www/html/;

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;

        fastcgi_pass unix:/var/run/php/php__PHPVERSION__-fpm.sock;
        # fastcgi_pass 127.0.0.1:9000;
    }
}

# production proxy
server {
    server_name 127.0.0.1;
    
    # standard proxy ports
    listen 80;
    listen 443 ssl;

    # customer specific proxy port
    listen MAIN_SERVER_PORT;

    access_log /var/log/nginx/upstream_logging.log upstream_logging;
    error_log /var/log/nginx/error.log error;

    ssl_certificate server.crt;
    ssl_certificate_key server.key;
    ssl_protocols SSLv3 TLSv1.1 TLSv1.2;

    proxy_buffering on;
    proxy_buffers 64 2048k;
    proxy_buffer_size 2048k;
    proxy_busy_buffers_size 2048k;
    proxy_max_temp_file_size 0;
        
    server_tokens off;
    chunked_transfer_encoding off;
        
    set_real_ip_from 0.0.0.0/0;
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # is country allowed to proxy or should we redirect
    if ($proxy_traffic = no) {
        # return 403;

        # forward to main server due to GEO IP rules
        rewrite (.*) http://MAIN_SERVER_IP_ADDRESS:MAIN_SERVER_PORT$1 redirect;
    }

    set $logme 0;
    if ( $uri ~ ^/get ) {
            set $logme 1;
    }
    if ( $uri ~ ^/player_api ) {
            set $logme 1;
    }
    if ( $uri ~ ^/portal ) {
            set $logme 1;
    }
    if ( $uri ~ ^/live ) {
            set $logme 1;
    }
    if ( $uri ~ ^/movie ) {
            set $logme 1;
    }
    if ( $uri ~ ^/series ) {
            set $logme 1;
    }

    # stalker portal
    location =/c {
        return 301 http://$host:MAIN_SERVER_PORT/c/;
    }

    # hls-php
    location ~* "^\/live\/(.*?)\/(.*?)\/(.*)\.m3u8" {
        proxy_pass http://$host:1372/hls_proxy.php?username=$1&password=$2&stream_id=$3&extension=m3u8;
    }

    # main proxy
    location / {
        # limit_req zone=subshieldLimit-OFF burst=20 nodelay;

        resolver 8.8.8.8 ipv6=off;
        resolver_timeout 10s;

        proxy_hide_header   Referer;
        proxy_hide_header   Origin;
        proxy_set_header    Referer                 '';
        proxy_set_header    Origin                  '';
        
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE';
        add_header 'Access-Control-Allow-Headers' 'DNT, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Range, Origin, X-Requested-With, Content-Type, Accept, Api-Password';
        add_header 'Access-Control-Expose-Headers' 'Content-Length, Content-Range';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' '600';
        add_header 'Vary' 'Origin';
        
        if ($request_method = OPTIONS) {
            # Handle OPTIONS method
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
        }
        
        proxy_pass http://main_server;
        
        proxy_pass_request_headers on;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        proxy_set_header Referer $http_referer;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $host:$server_port;
        proxy_set_header X-Forwarded-Host $host:$server_port;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header REMOTE_ADDR $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_read_timeout  36000s;
        proxy_set_header Accept-Encoding "";
        proxy_redirect off;
        
        subs_filter_types "*";
        sub_filter_once off;
        
        # sub_filter "MAIN_SERVER_DOMAIN_NAME" "$host";
        # subs_filter "MAIN_SERVER_DOMAIN_NAME" "$host";

        sub_filter "MAIN_SERVER_IP_ADDRESS" "$host";
        subs_filter "MAIN_SERVER_IP_ADDRESS" "$host";

        sub_filter "ADDITIONAL_SERVER_DOMAIN_1" "$host";
        subs_filter "ADDITIONAL_SERVER_DOMAIN_1" "$host";

        sub_filter "ADDITIONAL_SERVER_DOMAIN_2" "$host";
        subs_filter "ADDITIONAL_SERVER_DOMAIN_2" "$host";

        sub_filter "ADDITIONAL_SERVER_DOMAIN_3" "$host";
        subs_filter "ADDITIONAL_SERVER_DOMAIN_3" "$host";

        sub_filter "ADDITIONAL_SERVER_DOMAIN_4" "$host";
        subs_filter "ADDITIONAL_SERVER_DOMAIN_4" "$host";

        # set_real_ip_from PROXY_IP_ADDRESS/32; # Ip/network of the reverse proxy (or ip received into REMOTE_ADDR)
        real_ip_header X-Forwarded-For;

        # inline content rewrites
        subs_filter "Your STB is not supported" "IPTVShield.com: Unsupported Device";
        subs_filter "Nothing to see here. Move along now." "IPTVShield.com: No Content Available";
        subs_filter "Access Denied." "IPTVShield.com: Access Denied.";
        subs_filter "Access Denied!!!" "IPTVShield.com: Access Denied.";
        subs_filter "Hello" "IPTVShield.com: Access Denied.";
        subs_filter "Xtream Codes Reborn" "IPTVShield.com: Access Denied.";

        recursive_error_pages on;
        proxy_intercept_errors on;
        error_page 301 302 307 = @handle_redirect;
    }

    # proxied redirects
    location @handle_redirect {
        resolver 8.8.8.8 ipv6=off;
        resolver_timeout 10s;

        set $saved_redirect_location $upstream_http_location;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_pass $saved_redirect_location;
        recursive_error_pages on;
        proxy_intercept_errors on;
        error_page 301 302 307 = @handle_redirect;
    }
}
